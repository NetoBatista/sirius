
<div class="payment-create-content">
    <div class="d-grid">
        <span>* Nome</span>
        <input placeholder="Netflix" maxlength="256" @bind-value="request.Name" />
    </div>
    <div class="d-grid">
        <span>Descrição</span>
        <textarea placeholder="Plano premium" rows="5" maxlength="1000" @bind="request.Description" />
    </div>
    <div class="d-grid">
        <span>Valor</span>
        <InputNumber TValue="decimal" @bind-Value=request.Value class="currency-mask"></InputNumber>
    </div>
    <div class="d-grid">
        <span>Categoria</span>
        <select @bind="request.CategoryId">
            <option value="">Nenhum</option>
            @foreach (var category in categories)
            {
                <option value="@category.Id">@category.Name</option>
            }
        </select>
    </div>
    <div class="d-grid">
        <span>Dia do pagamento</span>
        <select @bind="request.PayDay">
            <option value="">Nenhum</option>
            @for (var index =1; index <= 31; index ++)
            {
                <option value="@index">@index</option>
            }
        </select>
    </div>
    <div class="d-flex payment-create-action">
        <button class="btn-default" @onclick=OnClickClose>
            Cancelar
        </button>
        <button class="btn-default" @onclick=OnClickCreate>
            Criar
        </button>
    </div>
    <div>
        <span style="color: red">@ErrorMessage</span>
    </div>
</div>

@code {
    [Inject]
    private DialogProvider dialogProvider { get; set; } = default!;
    [Inject]
    private IPaymentService paymentService { get; set; } = default!;
    [Inject]
    private ICategoryService categoryService { get; set; } = default!;
    [Inject]
    private ToastProvider toastProvider { get; set; } = default!;
    [Inject]
    private JavaScriptProvider javaScriptProvider { get; set; } = default!;
    private string ErrorMessage = "";
    private PaymentRequestDTO request = new PaymentRequestDTO();
    private List<CategoryResponseDTO> categories = new List<CategoryResponseDTO>();

    protected override void OnAfterRender(bool firstRender) => javaScriptProvider.ApplyCurrencyMask();

    protected override async Task OnInitializedAsync()
    {
        categories = await categoryService.GetAll();
        categories = categories.OrderBy(x => x.Name).ToList();
        StateHasChanged();
    }

    private async Task OnClickCreate()
    {
        try
        {
            if (string.IsNullOrEmpty(request.Name))
            {
                ErrorMessage = "Nome da pagamento é obrigatório";
                StateHasChanged();
                return;
            }
            if (await paymentService.Exists(request))
            {
                toastProvider.ShowToast("Já existe um pagamento com esse nome", ToastLevelEnum.Error);
                return;
            }
            var response = await paymentService.Create(request);
            toastProvider.ShowToast("Criado com sucesso", ToastLevelEnum.Success);
            dialogProvider.CloseDialog(response);
        }
        catch(Exception)
        {
            toastProvider.ShowToast("Erro ao criar pagamento", ToastLevelEnum.Error);
        }
    }

    private void OnClickClose()
    {
        dialogProvider.CloseDialog();
    }
}
